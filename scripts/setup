#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'
LANG=C

# shellcheck source=shellib/shellib.sh
. "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")/shellib/shellib.sh"

function setup() {
    # Install pre-commit for commit-msg hook
    if pre-commit install -t commit-msg 1>/dev/null; then
        info 'pre-commit hook is installed.'
    else
        err 'pre-commit hook installation failed'
        exit "$status_err"
    fi

    REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && git rev-parse --show-toplevel)"

    pushd "$REPO_DIR" 1>/dev/null

    # Install pre-commit hook if it's not present or doesn't point to the right location
    if [[ ! -L '.git/hooks/pre-commit' ]] || [ "$(readlink .git/hooks/pre-commit)" != '../../scripts/pre-commit' ]; then
        if ln -s ../../scripts/pre-commit .git/hooks/pre-commit; then
            info 'pre-commit hook has been installed.' "$symbol_done"
        else
            err 'pre-commit hook installation failed, cannot create symbolic link.'
            exit "$status_err"
        fi
    else
        info 'pre-commit hook is installed.'
    fi

    # Install pre-merge-commit hook if it's not present or doesn't point to the right location
    if [[ ! -L '.git/hooks/pre-merge-commit' ]] || [ "$(readlink .git/hooks/pre-merge-commit)" != '../../scripts/pre-commit' ]; then
        if ln -s ../../scripts/pre-commit .git/hooks/pre-merge-commit; then
            info 'pre-merge-commit hook has been installed.' "$symbol_done"
        else
            err 'pre-merge-commit hook installation failed, cannot create symbolic link.'
            exit "$status_err"
        fi
    else
        info 'pre-merge-commit hook is installed.'
    fi

    # Install pre-push hook if it's not present or doesn't point to the right location
    if [[ ! -L '.git/hooks/pre-push' ]] || [ "$(readlink .git/hooks/pre-push)" != '../../scripts/pre-push' ]; then
        if ln -s ../../scripts/pre-push .git/hooks/pre-push; then
            info 'pre-push hook has been installed.' "$symbol_done"
        else
            err 'pre-push hook installation failed, cannot create symbolic link.'
            exit "$status_err"
        fi
    else
        info 'pre-push hook is installed.'
    fi

    # Check if GL_TOKEN is set
    if [ -z "${GL_TOKEN:-}" ]; then
        warn 'environment variable GL_TOKEN is not set, gitlab-ci-linter will be skipped.'
        info 'You might set up environment variable GL_TOKEN at scripts/secrets.sh and source it.' "$symbol_tip"
    else
        info 'GL_TOKEN is set.'
    fi

    popd 1>/dev/null
}

# Main
function main() {
    if is_root; then
        err 'Superpowers might be more harmful than useful. Please run as a regular user.'
        return "$status_err"
    else
        # Skip execution under test
        if [ "${BASH_SOURCE[0]}" == "${0}" ]; then
            scripts/bootstrap
        fi
        setup
    fi
}

# Skip functions execution under test
if [ "${BASH_SOURCE[0]}" == "${0}" ]; then
    main
fi
